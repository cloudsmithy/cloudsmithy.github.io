### Kubernetes 探针（Probes）：确保应用健康运行

在本节课中，我们将介绍 Kubernetes 的 **探针（Probes）** 功能，特别是 **就绪探针（Readiness Probe）** 和 **存活探针（Liveness Probe）**，它们有助于确保容器在 Kubernetes 中的健康状态，进而提高应用的稳定性和可用性。

---

## 探针的概念

在 Kubernetes 中，**探针（Probes）** 是用于监控容器状态的重要工具。它们能够帮助 Kubernetes 判断容器是否准备好接受流量或是否进入故障状态，必要时重新启动容器。常见的探针类型有：

1. **就绪探针（Readiness Probe）**：用于检查容器是否准备好接受流量。如果容器尚未准备好，Kubernetes 将不会将流量路由到该容器。

2. **存活探针（Liveness Probe）**：用于检查容器是否健康。如果容器进入无法恢复的状态（如死锁），Kubernetes 会重启该容器。

### 就绪探针（Readiness Probe）

**就绪探针** 用于检测容器是否准备好接收流量。容器启动后，可能需要一定时间来加载配置或缓存，直到其完全准备好服务流量。

- **用途**：在 Pod 启动过程中，Kubernetes 会使用就绪探针监控容器的状态，直到它们准备好接受流量。如果 Pod 未准备好，Kubernetes 不会将流量发送到该 Pod。
- **场景**：例如，Pod 依赖外部服务或数据库，如果该服务或数据库不可用，Kubernetes 会暂停向该 Pod 发送流量，直到外部服务恢复。

### 存活探针（Liveness Probe）

**存活探针** 用于检查容器是否处于健康状态。如果容器进入了死锁或崩溃状态，存活探针会让 Kubernetes 重启该容器。

- **用途**：当容器无法响应请求，或者处于无法恢复的状态时，Kubernetes 会使用存活探针检测并自动重启该容器。
- **场景**：例如，容器可能会进入死锁状态，导致无法处理新的请求。存活探针会及时检测到这一点并触发容器重启。

---

## 如何配置探针

探针可以在 Pod 的 **容器规格（container spec）** 中配置。Kubernetes 提供了三种方式来检查容器状态：

1. **命令检查（Exec probe）**：通过在容器内执行命令来检查容器的健康状态。
2. **HTTP GET 请求（HTTP GET probe）**：通过向容器暴露的 HTTP 端口发送请求来检查容器状态。
3. **TCP Socket 检查（TCP Socket probe）**：尝试连接容器暴露的端口来检查容器是否健康。

### 探针配置示例

以下是 **Redis Pod** 和 **API 服务 Pod** 配置就绪探针和存活探针的示例。

#### 数据层（Redis Pod）的探针配置

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-tier
  namespace: service-discovery
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: data
  template:
    metadata:
      labels:
        tier: data
    spec:
      containers:
        - name: redis
          image: redis:latest
          ports:
            - containerPort: 6379
          readinessProbe:
            tcpSocket:
              port: 6379
          livenessProbe:
            tcpSocket:
              port: 6379
            initialDelaySeconds: 30
            periodSeconds: 10
```

- **readinessProbe**：用于检查 Redis 服务是否已经启动并能接收连接。
- **livenessProbe**：用于检测 Redis 是否在运行中，如果 Redis 崩溃或挂掉，Kubernetes 会重启该容器。

#### 应用层（API 服务）的探针配置

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-tier
  namespace: service-discovery
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: app
  template:
    metadata:
      labels:
        tier: app
    spec:
      containers:
        - name: server
          image: node:latest
          env:
            - name: REDIS_URL
              value: "data-tier:6379"
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
```

- **readinessProbe**：API 服务的就绪探针通过 HTTP GET 请求检查 `/healthz` 路径，确保 API 服务可以与 Redis 服务交互。
- **livenessProbe**：API 服务的存活探针也使用 HTTP GET 请求检查 `/healthz` 路径，确认 API 服务是否健康。

---

## 配置探针的最佳实践

1. **就绪探针与存活探针的初始延迟**：

   - 设置适当的 **initialDelaySeconds**，确保容器有足够时间启动并准备好处理流量。
   - 通常，存活探针的延迟要比就绪探针长，因为容器可能需要更多时间才能恢复正常。

2. **探针失败处理**：

   - 默认情况下，Kubernetes 会在探针失败 3 次后将容器标记为失败并进行重启。你可以通过配置 **failureThreshold** 来调整此行为。

3. **服务发现和负载均衡**：

   - **服务** 会使用 **就绪探针** 来决定是否将流量发送到某个 Pod。如果 Pod 的就绪探针失败，服务会停止将流量发送到该 Pod。

---

## 监控与调试

1. **查看 Pod 状态**：你可以使用 `kubectl get pods` 查看 Pod 是否准备好接收流量。

2. **查看探针状态**：使用 `kubectl describe pod <pod_name>` 来查看探针的执行情况和历史记录。

3. **查看容器日志**：你可以使用 `kubectl logs <pod_name> -f` 来查看容器的日志，帮助你调试探针失败的原因。

4. **重新启动 Pod**：如果需要重启 Pod，使用 `kubectl delete pod <pod_name>`，Kubernetes 会自动创建新的 Pod。

---

## 小结

在本节课中，我们介绍了 Kubernetes 中的 **探针（Probes）**：

1. **就绪探针**：用于检查容器是否准备好接收流量。
2. **存活探针**：用于检测容器是否健康，必要时重启容器。
3. 探针可以通过命令、HTTP GET 请求和 TCP socket 来检查容器状态。
4. Kubernetes 会基于探针的状态决定是否向 Pod 发送流量或重启 Pod。

下一节课，我们将学习如何使用 **初始化容器（Init Containers）**，以便在容器启动之前执行一些必要的初始化操作。
