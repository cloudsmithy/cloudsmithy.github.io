### Docker 端口映射与容器交互

在本节课中，我们学习了 Docker 如何处理端口映射，以及如何与在容器内运行的 Web 应用进行交互。让我们一步步详细分析。

#### Docker 容器端口绑定

Docker 容器默认运行在它们自己的内部网络中，与宿主机隔离。这意味着当容器内运行一个 Web 应用（例如在容器内部的 8080 端口），它默认并不能直接从宿主机访问。然而，Docker 允许将容器的端口映射到宿主机的端口，使得应用程序可以从外部访问。

有两种主要的端口映射方式：

1. **动态映射容器的端口到宿主机的端口**。
2. **显式地将宿主机的特定端口映射到容器内的端口**。

#### 步骤 1: 在容器中运行 Web 应用

为了演示 Docker 的端口映射，我们使用了一个简单的 Go 语言 Web 应用。该应用在容器内的 8080 端口监听并提供两个 API 接口。Dockerfile 的内容如下：

- 使用**scratch**基础镜像（一个没有操作系统的最小镜像）。
- 将`web app`二进制文件复制到容器中。
- 暴露 8080 端口，允许外部流量访问容器内的 Web 应用。
- 设置`CMD`指令，当容器启动时运行该二进制文件。

构建 Docker 镜像后，下一步是使用该镜像启动一个容器。

#### 步骤 2: 启动 Web 应用容器

最初，我们以如下命令启动容器：

```bash
docker run -d <image_name>
```

此时容器会启动并运行 Web 应用，但它默认在容器内部运行，并不会直接暴露给外部网络。为了与外部交互，我们需要进行端口映射。

#### 步骤 3: 使用 `-P` 动态端口映射

为了让容器的 8080 端口能够通过宿主机访问，我们使用`-P`标志来启动容器：

```bash
docker run -d -P <image_name>
```

此命令会动态地将容器内部的暴露端口（在此例中为 8080）映射到宿主机的一个空闲端口。你可以使用以下命令查看容器的端口映射：

```bash
docker ps
```

通过上述命令，Docker 会显示宿主机上绑定的端口。例如，容器可能会被映射到宿主机的 32768 端口，我们可以通过访问`localhost:32768`来访问 Web 应用。

#### 步骤 4: 使用 `-p` 显式端口映射

除了动态映射，Docker 还允许显式地指定将宿主机的特定端口映射到容器的端口。例如，我们希望将宿主机的 3000 端口映射到容器的 8080 端口。可以使用`-p`标志来实现：

```bash
docker run -d -p 3000:8080 <image_name>
```

此命令会将宿主机的 3000 端口与容器的 8080 端口绑定。此时，你可以通过访问`localhost:3000`来访问容器内运行的 Web 应用。

#### 步骤 5: 停止并清理容器

完成后，你可以使用以下命令停止并清理容器：

```bash
docker stop <container_id>
docker rm <container_id>
docker container prune
```

#### 总结

1. **动态映射端口**：使用`-P`标志，Docker 会自动将容器的暴露端口映射到宿主机的空闲端口。
2. **显式映射端口**：使用`-p`标志，显式指定宿主机和容器端口的映射关系。
3. **容器默认不会暴露端口**：尽管 Dockerfile 中包含`EXPOSE`指令，真正的端口映射需要通过命令行参数来显式或动态配置。
