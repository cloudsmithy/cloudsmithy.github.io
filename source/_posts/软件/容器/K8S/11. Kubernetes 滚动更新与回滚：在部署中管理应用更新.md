### Kubernetes 滚动更新与回滚：在部署中管理应用更新

Kubernetes 的 **部署（Deployment）** 提供了强大的功能来管理应用的副本，并通过 **滚动更新** 来平滑地更新应用而不会造成停机。在本节课中，我们将学习如何使用 Kubernetes 进行 **滚动更新** 和 **回滚**，并展示如何处理部署中的更新操作。

---

## 滚动更新概述

**滚动更新** 是 Kubernetes 默认的更新策略。它允许我们在不间断服务的情况下，逐步替换旧版本的 Pod 为新版本的 Pod。滚动更新的一大优势是它保证在更新过程中，服务始终可用，不会因为更新而停机。每次更新仅更新一部分副本，直到所有副本都被更新完成。

### 滚动更新的工作原理

1. **更新模板**：当你更新部署模板（如更改容器镜像、环境变量、标签等）时，Kubernetes 会自动触发滚动更新。
2. **逐步替换副本**：Kubernetes 会逐步增加新副本并删除旧副本，直到所有副本都更新为新版本。
3. **可用性**：更新过程中会有部分 Pod 使用新版本，部分 Pod 使用旧版本。因此，应用需要能够平滑地处理这种版本不一致的情况。

---

## 更新部署

我们将继续使用上节课的 **微服务三层应用**，并通过 **部署** 来管理 Pods。在本节课中，我们将触发一个简单的部署更新，看看滚动更新是如何工作的。

### 更新应用部署

首先，我们将删除现有的 **自动扩缩配置**，以便观察更新的过程。删除自动扩缩器后，我们可以更容易地观察到滚动更新。

```bash
kubectl delete hpa app-tier -n deployments
```

接下来，我们将编辑 **应用层部署**，将副本数从 2 改为 10，并移除 **CPU 请求** 设置。这样做是为了简化操作，避免由于 CPU 请求导致 Pod 调度问题。

```bash
kubectl edit deployment app-tier -n deployments
```

在编辑器中，修改副本数和资源请求，保存并退出。

---

## 触发滚动更新

现在我们将触发一个更新，通过更新容器的镜像标签来演示滚动更新的过程。这次更新只会改变容器的镜像标签，但它足以触发一个滚动更新。

1. 打开 **应用层部署**，修改容器镜像标签（例如，从 `cloudacademy:v1` 改为 `cloudacademy:v2`）。
2. 使用 `kubectl apply` 触发部署更新：

```bash
kubectl apply -f app-tier-deployment.yaml -n deployments
```

3. 观察滚动更新的状态：

```bash
kubectl rollout status deployment/app-tier -n deployments
```

这将显示每次更新的进度，你会看到新副本逐步替换旧副本。

---

## 暂停和恢复滚动更新

Kubernetes 允许我们在滚动更新过程中暂停并恢复更新操作。可以通过 `kubectl rollout pause` 和 `kubectl rollout resume` 命令来实现。

1. **暂停滚动更新**：

```bash
kubectl rollout pause deployment/app-tier -n deployments
```

2. **恢复滚动更新**：

```bash
kubectl rollout resume deployment/app-tier -n deployments
```

这允许我们在更新过程中灵活控制进度。

---

## 回滚部署

如果更新过程中出现问题，Kubernetes 允许我们 **回滚到先前的版本**。通过 `kubectl rollout undo` 命令，我们可以轻松地将部署恢复到之前的状态。

1. **回滚到上一版本**：

```bash
kubectl rollout undo deployment/app-tier -n deployments
```

2. **查看历史版本**：

```bash
kubectl rollout history deployment/app-tier -n deployments
```

通过 `kubectl rollout history`，我们可以查看部署的历史记录，找到并回滚到特定的版本。

---

## 扩展与滚动更新

在 Kubernetes 中，扩展和滚动更新是两个独立的概念：

- **扩展**：可以通过增加副本数来扩展应用，保证负载均衡。
- **滚动更新**：在不中断服务的情况下，逐步更新容器镜像或配置。

### 扩展部署

假设我们希望扩展 **应用层部署**，可以使用 `kubectl scale` 命令来增加副本数：

```bash
kubectl scale deployment app-tier -n deployments --replicas=5
```

然后，我们可以通过查看 Pods 状态确认扩展后的副本：

```bash
kubectl get pods -n deployments
```

---

## 小结

在本节课中，我们学习了如何使用 **滚动更新** 来更新 Kubernetes 部署：

1. **滚动更新** 允许我们平滑地替换旧版本的 Pod，为新版本的 Pod 提供无缝过渡。
2. 我们介绍了如何通过 `kubectl` 命令暂停、恢复和回滚滚动更新。
3. **扩展** 和 **滚动更新** 是 Kubernetes 部署管理的两个重要特性，它们可以帮助我们高效地管理应用。

在下一节课中，我们将探讨如何结合 **探针（Probes）** 和 **初始化容器（Init Containers）** 来确保容器在健康和启动时满足特定条件。
