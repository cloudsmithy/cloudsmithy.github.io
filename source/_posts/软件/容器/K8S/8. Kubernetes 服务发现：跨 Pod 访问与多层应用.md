### Kubernetes 服务发现：跨 Pod 访问与多层应用

在 Kubernetes 中，**服务（Service）** 不仅仅用于暴露 Pod 给外部，还可以有效地在集群内部进行服务发现和负载均衡。通过将多个 Pod 分层并结合服务，我们能够更好地管理和扩展应用。

在本节课中，我们将通过构建一个 **多层应用**，学习如何在集群内部使用 **服务发现**，包括基于 **环境变量** 和 **DNS** 的服务发现机制。

---

## 应用架构

我们将构建一个 **多层应用**，该应用包含 **3 个层次**，分布在 **多个容器和 Pod** 中：

1. **数据层**：使用 **Redis** 存储计数器。
2. **应用层**：包括一个 **Node.js 服务器**，用于处理 POST 请求递增计数器值，处理 GET 请求获取当前计数值。
3. **支持层**：包括 **Poller** 和 **Counter** 容器，用于定期发送请求获取和更新计数器。

为了确保各层之间能够高效通信，我们将使用 Kubernetes **服务** 来暴露每一层，并实现 **服务发现**。

---

## 创建 Namespace

**Namespace** 用于隔离 Kubernetes 中的资源，可以将不同的应用或环境分开管理。在本节课中，我们为服务发现应用创建了一个名为 `service-discovery` 的 Namespace。

### 创建 Namespace

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: service-discovery
  labels:
    app: microservices
```

通过以下命令创建该 Namespace：

```bash
kubectl create -f service-discovery-namespace.yaml
```

---

## 创建数据层服务与 Pod

在数据层，我们将创建一个 **Redis 服务** 和相应的 Redis **Pod**。Redis 服务将暴露给应用层，便于服务器容器访问。

### 数据层服务与 Pod Manifest 文件

```yaml
apiVersion: v1
kind: Service
metadata:
  name: data-tier
  namespace: service-discovery
spec:
  selector:
    tier: data
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
  clusterIP: None

---
apiVersion: v1
kind: Pod
metadata:
  name: redis
  namespace: service-discovery
  labels:
    tier: data
spec:
  containers:
    - name: redis
      image: redis:latest
      ports:
        - containerPort: 6379
```

### 创建数据层服务和 Pod

使用以下命令创建数据层服务和 Pod：

```bash
kubectl create -f data-tier.yaml -n service-discovery
```

### 查看数据层 Pod 和服务状态

```bash
kubectl get pods -n service-discovery
kubectl describe service -n service-discovery data-tier
```

此时，你应该能看到 **data-tier 服务** 和 **Redis Pod** 的详细信息，确保服务已经成功创建，并且 Redis Pod 作为服务端点。

---

## 创建应用层服务与 Pod

在应用层，我们将创建一个 **服务器服务** 和相应的 **Node.js 服务器 Pod**。此服务会通过 DNS 或环境变量使得其他 Pod 能够访问 Redis 服务。

### 应用层服务与 Pod Manifest 文件

```yaml
apiVersion: v1
kind: Service
metadata:
  name: app-tier
  namespace: service-discovery
spec:
  selector:
    tier: app
  ports:
    - name: server
      port: 8080
      targetPort: 8080

---
apiVersion: v1
kind: Pod
metadata:
  name: server
  namespace: service-discovery
  labels:
    tier: app
spec:
  containers:
    - name: server
      image: node:latest
      env:
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: service-discovery
              key: data-tier
      ports:
        - containerPort: 8080
```

### 创建应用层服务和 Pod

```bash
kubectl create -f app-tier.yaml -n service-discovery
```

---

## 使用 DNS 和环境变量进行服务发现

Kubernetes 提供了两种方式来进行 **服务发现**：

1. **环境变量**：Kubernetes 会为每个服务注入环境变量，帮助容器找到目标服务。
2. **DNS**：Kubernetes 会为每个服务创建 DNS 记录，容器可以通过 DNS 名称访问服务。

### 通过环境变量访问服务

当服务器容器启动时，它会从环境变量中获取 Redis 服务的 IP 地址，环境变量的格式如下：

```bash
REDIS_URL=data-tier-service-host
```

Kubernetes 会通过服务名称 **data-tier-service-host** 自动解析为相应的服务地址。

### 通过 DNS 访问服务

Pod 可以通过服务名称直接使用 DNS 进行访问。在我们的示例中，服务器容器会通过 **app-tier.service-discovery** 访问应用层服务。

---

## 创建支持层 Pod

支持层包含 **Poller** 和 **Counter** 容器，这两个容器会通过 **DNS** 或环境变量与应用层服务进行通信。

### 支持层 Pod Manifest 文件

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: support-tier
  namespace: service-discovery
spec:
  containers:
    - name: counter
      image: counter-app:latest
      env:
        - name: API_URL
          value: "http://app-tier.service-discovery"
    - name: poller
      image: poller-app:latest
      env:
        - name: API_URL
          value: "http://app-tier.service-discovery"
```

### 创建支持层 Pod

```bash
kubectl create -f support-tier.yaml -n service-discovery
```

---

## 查看所有 Pods 和日志

在应用创建并启动之后，可以使用以下命令查看 Pod 状态和容器日志：

```bash
kubectl get pods -n service-discovery
kubectl logs -n service-discovery support-tier poller -f
```

通过实时查看日志，确保容器按预期工作。

---

## 小结

在本节课中，我们学习了如何通过 **服务发现** 在 Kubernetes 中连接和管理多个 Pod：

1. 我们使用 **服务** 作为不同层之间的接口，避免直接使用 Pod 的 IP 地址；
2. 介绍了如何使用 **环境变量** 和 **DNS** 进行服务发现；
3. 通过将不同的容器分配到多个 Pod，并使用服务来连接它们，实现了一个多层架构。

在下一节课中，我们将探讨如何在 Kubernetes 中进行应用 **扩展**，以便在实际生产环境中更高效地管理容器。
