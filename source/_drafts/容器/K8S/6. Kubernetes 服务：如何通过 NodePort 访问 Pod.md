---
abbrlink: '0'
---
### Kubernetes 服务：如何通过 NodePort 访问 Pod

在上一课中，我们成功创建了一个 Web 服务器 Pod。然而，由于其 IP 地址是动态分配的，并且 Pods 之间的通信仅限于容器网络内，这个 Web 服务器仍然无法从集群外部或其他 Pod 外部访问。为了能从外部访问该 Web 服务，我们需要引入 **Kubernetes 服务（Service）**。

本节课将介绍如何通过 **Service** 来解决 Pod 访问性问题，特别是如何使用 **NodePort 服务** 从外部访问 Pod。

---

## 什么是 Kubernetes 服务？

Kubernetes 服务是一个抽象层，用于定义 Pods 的网络访问规则。通过服务，你可以将客户端请求路由到匹配的 Pods，且服务会提供一个静态的 IP 地址和端口，使得 Pods 即使在重新调度时也能通过固定地址访问。

服务提供了负载均衡功能，能够将请求均匀分发到多个匹配的 Pods 上，保证请求的高可用性。

### 服务的工作原理：

1. **标签选择器（Selector）**：服务通过标签选择器来选择一组 Pods。例如，可以使用 `app=webserver` 标签选择所有 Web 服务器 Pods。
2. **静态 IP**：服务会分配一个 **Cluster IP**，用于集群内部访问该服务。
3. **端口映射**：服务通过端口映射将请求发送到相应的 Pod。如果使用 NodePort 服务，还可以让服务通过集群外部的端口进行访问。

---

## 创建一个 NodePort 服务

### 步骤 1：定义服务的 Manifest 文件

我们将通过创建一个服务的 Manifest 文件，定义服务的类型、选择器、端口等属性。以下是一个简单的 NodePort 服务 Manifest 文件示例：

```yaml
apiVersion: v1
kind: Service
metadata:
  name: webserver-service
  labels:
    app: webserver
spec:
  selector:
    app: webserver # 服务选择标签为 app=webserver 的 Pod
  ports:
    - protocol: TCP
      port: 80 # 服务的端口
      targetPort: 80 # 指定容器内的端口
      nodePort: 30001 # NodePort，外部访问的端口
  type: NodePort # 服务类型为 NodePort
```

- **selector**: 使用标签选择器选择要暴露的 Pods（本例中选择标签为 `app=webserver` 的 Pods）。
- **ports**: 定义服务的端口映射。这里将 Pod 内部的 80 端口映射到外部的 30001 端口。
- **type: NodePort**: 设置服务类型为 NodePort，使得服务能通过集群节点的外部 IP 和指定端口访问。

### 步骤 2：创建服务

使用 `kubectl create` 命令创建服务：

```bash
kubectl create -f webserver-service.yaml
```

### 步骤 3：查看服务状态

创建服务后，可以使用以下命令查看服务的状态：

```bash
kubectl get services
```

输出中会显示服务的 **Cluster IP**、**NodePort** 和端口等信息。例如：

```
NAME                TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
webserver-service   NodePort   10.103.92.123   <none>        80:30001/TCP   5m
```

- **Cluster IP**: 服务的内部 IP 地址。
- **NodePort**: 集群外部可以访问服务的端口。

### 步骤 4：访问服务

为了从集群外部访问 Web 服务，你可以使用任意节点的 **Node IP** 和指定的 **NodePort** 端口。首先，使用以下命令查看节点的 IP 地址：

```bash
kubectl describe nodes | grep -i address -A 1
```

然后，使用 `curl` 发送请求访问 Web 服务：

```bash
curl http://<node-ip>:30001
```

你将看到 Nginx 服务器返回的 HTML 页面，表示 Web 服务已经成功暴露并可以从外部访问。

---

## 小结

在本节课中，我们学习了如何使用 **NodePort 服务** 来解决 Pod 访问性问题。通过定义服务，我们可以为一组 Pod 提供一个固定的访问地址，即使 Pods 被重新调度到其他节点，也能通过该地址访问：

- **Selector**：选择与服务匹配的 Pods。
- **Ports**：配置服务的端口映射，使 Pod 的端口对外暴露。
- **NodePort**：使服务能够通过集群节点的外部 IP 和端口访问。

在下一节课中，我们将进一步探讨如何在 Kubernetes 中使用 **多容器 Pod** 来支持更复杂的应用。
