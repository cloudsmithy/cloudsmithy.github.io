### Kubernetes 存储：理解 Volumes 和 Persistent Volumes 的使用

在 Kubernetes 中，Pod 内的容器共享网络栈，但每个容器都有独立的文件系统。容器重启时，数据会丢失，尤其是当容器因故障或失败被重启时。因此，如何管理容器的数据成为了 Kubernetes 使用中的一个重要话题。

本篇博客将介绍 Kubernetes 如何处理持久化存储，聚焦于**Volumes**和\*\*Persistent Volumes（PV）\*\*的应用，帮助我们避免容器崩溃导致的数据丢失。

#### 1. **Kubernetes 存储类型**

Kubernetes 中有两种存储类型：

- **Volume**：与 Pod 生命周期密切相关，Pod 删除时数据会被删除。适用于需要短期存储的场景。
- **Persistent Volume（PV）**：独立于 Pod 生命周期。即使 Pod 被删除或迁移，数据依然存在。适合用于持久化数据。

#### 2. **Kubernetes Volume 的种类**

- **emptyDir**：最常用的 Volume 类型，Pod 启动时创建为空，当 Pod 删除时数据会丢失。适合用于存储临时数据。
- **Persistent Volume（PV）**：这种 Volume 类型独立于 Pod 生命周期，适合用于存储需要持久保存的数据。

#### 3. **Persistent Volumes 的优势**

- **持久性**：数据不会因 Pod 重启或删除而丢失，持久卷可以在多个 Pod 间共享。
- **灵活性**：PV 可以是云供应商提供的存储（如 Amazon EBS、Google Cloud Persistent Disk 等），也可以使用 NFS 等网络存储。

#### 4. **如何在 Kubernetes 中配置 Persistent Volumes**

通过配置 Persistent Volumes，Pods 可以声明对存储的需求。每个 Pod 需要一个\*\*Persistent Volume Claim（PVC）\*\*来请求存储空间。PVC 会自动与符合要求的 PV 绑定，并允许 Pod 使用这些存储资源。

- **Persistent Volume（PV）**：管理实际存储，通常由管理员配置。
- **Persistent Volume Claim（PVC）**：由用户在 Pod 中声明，表示 Pod 需要某种类型的存储。

#### 5. **使用 Persistent Volume 的示例**

我们以一个 Redis 数据层为例，展示如何使用 Persistent Volume 来持久化数据。在应用中，数据需要在 Pod 重启后保存，避免容器重启导致的数据丢失。

##### 配置 Persistent Volume（PV）

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-data-pv
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  awsElasticBlockStore:
    volumeID: <YOUR_VOLUME_ID>
    fsType: ext4
```

##### 配置 Persistent Volume Claim（PVC）

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-data-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
```

##### 配置 Pod 来使用 PVC

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: redis-data-tier
spec:
  containers:
    - name: redis
      image: redis
      volumeMounts:
        - mountPath: /data
          name: redis-data-volume
  volumes:
    - name: redis-data-volume
      persistentVolumeClaim:
        claimName: redis-data-pvc
```

#### 6. **验证数据持久化**

在配置完 Persistent Volume（PV）和 Persistent Volume Claim（PVC）后，当 Pod 重启或删除时，数据会保存在持久存储中，不会丢失。这使得 Kubernetes 的持久化存储功能对管理有重要数据的应用非常有用。

#### 7. **总结**

- **Volumes**用于临时数据存储，适合容器重启时不会丢失的数据。
- \*\*Persistent Volumes (PV)\*\*则用于持久化存储，确保数据在 Pod 生命周期之外得以保留。
- \*\*Persistent Volume Claim (PVC)\*\*允许 Pod 声明所需的存储资源，并将其与 PV 绑定，确保数据持久化。

Kubernetes 的存储管理让开发者能够灵活管理数据，避免 Pod 生命周期对数据的影响，提供了灵活的持久化存储选项，从而保障应用的稳定性和可靠性。

希望本文能帮助你理解 Kubernetes 的存储机制，并通过实践应用持久化存储来解决数据丢失的问题。如果你有更多关于 Kubernetes 存储的疑问，欢迎继续学习并实践。

### Kubernetes 本地存储与 SMB 存储配置示例

在 Kubernetes 中，我们可以使用多种存储方式来满足不同的需求。对于本地存储和网络共享存储（如 SMB），我们可以通过使用\*\*Persistent Volumes（PV）**和**Persistent Volume Claims（PVC）\*\*来进行数据持久化和共享。

本文将演示如何使用本地存储和 SMB 作为 Kubernetes 存储的解决方案，并结合示例配置。

---

### 1. 本地存储（Local Storage）配置

在 Kubernetes 中使用本地存储时，通常我们会选择物理磁盘、SSD 或其他本地存储作为存储后端。下面是一个本地存储的示例配置：

#### 配置 Persistent Volume（PV）

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  local:
    path: /mnt/disks/ssd1 # 这是本地磁盘的路径
  volumeMode: Filesystem
```

#### 配置 Persistent Volume Claim（PVC）

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: local-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

#### 配置 Pod 使用本地存储

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: local-storage-pod
spec:
  containers:
    - name: nginx
      image: nginx
      volumeMounts:
        - mountPath: /usr/share/nginx/html
          name: local-storage
  volumes:
    - name: local-storage
      persistentVolumeClaim:
        claimName: local-pvc
```

在这个示例中，我们使用了本地路径`/mnt/disks/ssd1`来配置一个持久化卷（Persistent Volume），然后通过 Persistent Volume Claim（PVC）来请求使用该卷。Pod 会将该卷挂载到`/usr/share/nginx/html`路径，确保数据存储在本地磁盘上。

---

### 2. 使用 SMB 共享存储

SMB（Server Message Block）是一个广泛使用的网络共享协议，常见于 Windows 文件共享。Kubernetes 支持通过 SMB 协议挂载共享文件存储。下面是如何通过 SMB 配置 Persistent Volume（PV）和 Persistent Volume Claim（PVC）来实现 SMB 存储。

#### 配置 Persistent Volume（PV）使用 SMB

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: smb-pv
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: smb-storage
  csi:
    driver: smb.csi.k8s.io
    volumeHandle: my-smb-share
    volumeAttributes:
      source: "//<SMB_SERVER_IP>/share_name" # SMB服务器地址及共享名称
    nodeStageSecretRef:
      name: smb-secret
      namespace: default
```

#### 配置 Persistent Volume Claim（PVC）

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: smb-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: smb-storage
```

#### 配置 Kubernetes Secret（用于 SMB 认证）

为了安全地访问 SMB 共享，我们需要提供认证信息（如用户名和密码）。在 Kubernetes 中，使用`Secret`存储认证信息。

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: smb-secret
type: Opaque
data:
  username: <base64_encoded_username>
  password: <base64_encoded_password>
```

#### 配置 Pod 使用 SMB 存储

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: smb-storage-pod
spec:
  containers:
    - name: nginx
      image: nginx
      volumeMounts:
        - mountPath: /usr/share/nginx/html
          name: smb-storage
  volumes:
    - name: smb-storage
      persistentVolumeClaim:
        claimName: smb-pvc
```

在这个例子中，我们通过 SMB 协议连接到一个远程共享，`//<SMB_SERVER_IP>/share_name`代表共享路径。通过 Kubernetes 的`CSI`驱动，我们可以挂载这个共享存储，并将其挂载到 Pod 的`/usr/share/nginx/html`路径。

需要注意的是，SMB 挂载会依赖于**CSI 驱动**，并且需要在 Kubernetes 集群中安装适当的驱动程序（例如：`smb.csi.k8s.io`）。另外，使用 SMB 挂载时需要配置`Secret`来存储共享的访问凭证。

---

### 总结

在 Kubernetes 中使用存储时，我们有不同的选项：

1. **本地存储**：适用于需要容忍 Pod 重启的临时数据存储。
2. **SMB 存储**：适用于跨 Pod 共享数据或需要持久化存储的场景。

使用**Persistent Volumes**和**Persistent Volume Claims**可以灵活地管理存储，并且支持不同类型的存储解决方案（如本地磁盘、NFS、SMB 等）。通过配置**SMB**，你可以轻松实现跨 Pod 或跨节点的共享文件系统，为应用程序提供持久化存储的能力。
