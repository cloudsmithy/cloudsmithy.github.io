---
abbrlink: '0'
---
### Kubernetes 部署（Deployment）：管理应用的副本和扩展

在 Kubernetes 中，**Pod** 是最基本的部署单元，但通常我们不会直接创建 Pod。为了更好地管理和扩展应用，Kubernetes 提供了 **部署（Deployment）** 这一高级抽象。通过使用部署，我们可以更轻松地管理应用的副本、扩展、回滚等操作。

在本节课中，我们将通过 **部署** 来管理多容器 Pod，并介绍如何在 Kubernetes 中进行扩展和滚动更新。

---

## 部署的概念

**部署（Deployment）** 是用来管理多个 Pod 副本的。每个 Pod 都是从同一个模板创建的，因此它们是相同的。通过在部署中指定所需的 Pod 数量（如 5 个 Redis 副本），Kubernetes 会自动创建、管理并确保所需数量的 Pod 运行。如果某个 Pod 被删除，Kubernetes 会自动创建新的 Pod 来替代它。你还可以随时修改所需的副本数量，Kubernetes 会自动调整集群的实际状态以匹配你的目标状态。

### 部署的工作原理

- **Pod 模板**：部署使用 Pod 模板来创建 Pod，每个 Pod 副本都会使用这个模板。
- **副本数**：你可以在部署的规范中指定副本数，Kubernetes 会确保这个数量的 Pod 始终运行。
- **标签选择器**：部署通过标签选择器来选择哪些 Pod 属于这个部署。
- **部署控制器**：Kubernetes 的部署控制器会管理部署的生命周期，确保 Pod 始终处于期望的状态。

---

## 在部署中使用微服务应用

为了展示如何使用部署来管理 Pods，我们将使用前面创建的 **微服务 3 层应用**，并将每个层级的 Pod 替换为由部署管理的 Pod。

### 创建 Namespace

首先，我们为本节课创建一个新的 Namespace，名为 `deployments`，用于组织和管理该应用。

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: deployments
  labels:
    app: microservices
```

通过以下命令创建该 Namespace：

```bash
kubectl create -f deployments-namespace.yaml
```

---

## 数据层部署

我们将创建一个 **Redis 部署**，来代替之前的单个 Redis Pod。该部署会管理多个 Redis 副本，以确保应用的高可用性。

### 数据层部署 Manifest 文件

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-tier
  namespace: deployments
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: data
  template:
    metadata:
      labels:
        tier: data
    spec:
      containers:
        - name: redis
          image: redis:latest
          ports:
            - containerPort: 6379
```

- **replicas**：指定部署需要的 Redis Pod 副本数量，设置为 1 表示一个副本。
- **selector**：标签选择器，用来选择 Pod 进行管理。
- **template**：Pod 模板，定义 Pod 的规格和容器配置。

### 创建数据层部署

```bash
kubectl create -f data-tier-deployment.yaml -n deployments
```

---

## 应用层部署

在应用层，我们创建一个 **服务器部署**，它管理运行 Node.js 应用的容器。服务器将与数据层的 Redis 服务进行交互。

### 应用层部署 Manifest 文件

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-tier
  namespace: deployments
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: app
  template:
    metadata:
      labels:
        tier: app
    spec:
      containers:
        - name: server
          image: node:latest
          env:
            - name: REDIS_URL
              value: "data-tier:6379" # 服务发现，通过服务名访问 Redis
          ports:
            - containerPort: 8080
```

- **env**：设置 `REDIS_URL` 环境变量，指向数据层服务 `data-tier:6379`。

### 创建应用层部署

```bash
kubectl create -f app-tier-deployment.yaml -n deployments
```

---

## 支持层部署

支持层不需要单独的服务，而是通过 DNS 进行服务发现。我们将创建一个 **支持层部署**，它管理 **Poller** 和 **Counter** 容器，并通过 DNS 查找应用层的服务。

### 支持层部署 Manifest 文件

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: support-tier
  namespace: deployments
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: support
  template:
    metadata:
      labels:
        tier: support
    spec:
      containers:
        - name: counter
          image: counter-app:latest
          env:
            - name: API_URL
              value: "app-tier:8080"
        - name: poller
          image: poller-app:latest
          env:
            - name: API_URL
              value: "app-tier:8080"
```

### 创建支持层部署

```bash
kubectl create -f support-tier-deployment.yaml -n deployments
```

---

## 查看所有部署和 Pods

创建完部署后，可以使用以下命令查看所有的部署和 Pod 状态：

```bash
kubectl get deployments -n deployments
kubectl get pods -n deployments
```

你将看到三个部署，分别是 **数据层、应用层和支持层**，每个部署都包含一个副本的 Pod。

---

## 扩展部署

通过 `kubectl scale` 命令，我们可以修改部署的副本数量。这对于 **扩展** 和 **缩减** 应用非常有用。

### 扩展应用层部署

```bash
kubectl scale deployment app-tier -n deployments --replicas=5
```

### 查看扩展后的 Pods

```bash
kubectl get pods -n deployments
```

你将看到 **应用层** 的 Pod 数量已经增加至 5 个，Kubernetes 会自动管理这些副本并确保它们处于正常运行状态。

---

## 小结

在本节课中，我们学习了如何使用 **部署（Deployment）** 来管理和扩展 Kubernetes 中的应用：

1. **部署** 通过模板创建多个 Pod 副本，确保应用的高可用性；
2. 我们学习了如何通过 **环境变量** 和 **DNS** 进行服务发现；
3. 使用 **kubectl scale** 来扩展和缩减部署的副本数量。

在下一节课中，我们将介绍如何使用 **滚动更新** 来平滑地更新应用，确保在更新过程中不影响服务的可用性。
