---
title: æ‡’çŒ«å¾®æœè¿›é˜¶å¿ƒå¾—ï¼ˆä¸‰ï¼‰ï¼šä¸€å°æœºå™¨è·‘ä¸‰å¥— Dockerï¼Ÿæ·±å…¥è§£ææ‡’çŒ«å®¹å™¨çš„å…±å­˜æœºåˆ¶ï¼ˆä¸‹ï¼‰
tags: Docker
toc: true
categories: æ‡’çŒ«å¾®æœ
date: 2025-05-21 00:00:00
---

åœ¨ä¸Šä¸€æœŸé‡Œï¼Œæˆ‘ä»¬å‰–æäº†æ‡’çŒ«å¾®æœåŸç”Ÿçš„ä¸‰å¥— Docker å…±å­˜æ–¹æ¡ˆï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆåœ¨æ‡’çŒ«å¾®æœä¸Šå¯åŠ¨æ–°çš„ dev-docker å¼•æ“ï¼Œæ—¢èƒ½æ‹“å±•ä½¿ç”¨ï¼Œä½†åˆä¸ä¸ç°æœ‰ç¯å¢ƒç›¸äº’æ±¡æŸ“ã€‚

> **æ ¸å¿ƒæ€è·¯**
>
> 1. ç‹¬ç«‹ `daemon.json` æŒ‡å®šä¸“å±æ•°æ®ç›®å½• / Socket
> 2. ä¸€ä¸ªåŒ…è£…è„šæœ¬ `dev-docker` è®©ä½ ç…§å¸¸æ•² `docker` å‘½ä»¤
> 3. éœ€è¦æ—¶éšæ—¶å¯ç”¨ï¼Œä¸ç”¨æ—¶ä¸€æ¡å‘½ä»¤å³å¸è½½

### ç›®å½•è§„åˆ’

æˆ‘ç›®å‰æ˜¯åœ¨ root ç›®å½•ä¸‹æ–°å»ºäº†ä¸€ä¸ª dev ç›®å½•ï¼Œæ–°çš„å®¹å™¨æ‰€æœ‰æ•°æ®éƒ½åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚

```
.
â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ data/      # é•œåƒå±‚ã€å®¹å™¨å…ƒæ•°æ®
â”‚   â”œâ”€â”€ exec/      # è¿è¡Œæ—¶æ–‡ä»¶
â”‚   â””â”€â”€ daemon.json
â””â”€â”€ dev-docker      # åŒ…è£…è„šæœ¬ï¼Œç…§æ ·æ•² `docker`
```

<!-- more -->

> **æç¤º**ï¼š`docker.sock`ã€`docker.pid` ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆåˆ° `dev/` é‡Œã€‚

---

### ç”Ÿæˆ `daemon.json`

è¿™ä¸ªæ˜¯ä¸»è¦çš„æ–‡ä»¶ï¼Œå®šä¹‰äº† dev-docker çš„æ•°æ®ç›®å½•ï¼Œä»¥åŠå‘½åç©ºé—´çš„éš”ç¦»ã€‚

```bash
# å…ˆæ‹¿åˆ°ç»å¯¹è·¯å¾„ï¼Œé¿å… dockerd æŠ¥ç›¸å¯¹è·¯å¾„é”™è¯¯
DDIR=$(realpath ./dev)

cat > $DDIR/daemon.json <<EOF
{
  "data-root": "$DDIR/data",
  "exec-root": "$DDIR/exec",
  "pidfile": "$DDIR/docker.pid",
  "hosts": ["unix://$DDIR/docker.sock"],
  "containerd-namespace": "dev-docker",
  "containerd-plugins-namespace": "dev-docker"
}
EOF
```

### å¯åŠ¨ dev-docker å¼•æ“

ä½¿ç”¨ dockerd æŒ‡å®šé…ç½®æ–‡ä»¶å¯åŠ¨ dev-dockerï¼Œç„¶åæ”¾åœ¨åå°è¿›è¡Œã€‚

```bash
sudo dockerd --config-file=$DDIR/daemon.json --log-level=info &
```

æ‰§è¡Œä¹‹åå¾—åˆ°å¦‚ä¸‹çš„ç»“æœï¼š

```
INFO[2025-05-20T12:55:02.072949048Z] detected 127.0.0.53 nameserver, assuming systemd-resolved, so using resolv.conf: /run/systemd/resolve/resolv.conf
INFO[2025-05-20T12:55:02.157745008Z] Loading containers: start.
INFO[2025-05-20T12:55:02.331021502Z] Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --bip can be used to set a preferred IP address
INFO[2025-05-20T12:55:02.394567874Z] Loading containers: done.
INFO[2025-05-20T12:55:02.413944743Z] Docker daemon                                 commit="26.1.3-0ubuntu1~24.04.1" containerd-snapshotter=false storage-driver=overlay2 version=26.1.3
INFO[2025-05-20T12:55:02.414179613Z] Daemon has completed initialization
INFO[2025-05-20T12:55:02.471933824Z] API listen on /home/ubuntu/ddd/dev/docker.sock
```

---

### ä¸€ä¸ª `dev-docker` åŒ…è£…è„šæœ¬

è¿™ä¸ªè„šæœ¬å°±æ˜¯ä»¿ç…§æ‡’çŒ«å¾®å¹…å…¶ä»–çš„ docker å®ç°ï¼š

```bash
cat > ./dev-docker <<'EOF'
#!/usr/bin/env bash
export DOCKER_HOST=unix://$(realpath ./dev/docker.sock)
exec docker "$@"
EOF

chmod +x ./dev-docker
```

è®¾å®š`DOCKER_HOST=unix://$(realpath ./dev/docker.sock)`ï¼Œç„¶åç”¨ `exec docker "$@"` æŠŠæ”¶åˆ°çš„å…¨éƒ¨å‚æ•°åŸå°ä¸åŠ¨äº¤ç»™çœŸå®çš„ `docker` å‘½ä»¤æ‰§è¡Œã€‚

ç„¶åå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼š

```bash
./dev-docker ps
./dev-docker run -d -p 8080:80 nginx
```

![](https://fastly.jsdelivr.net/gh/bucketio/img0@main/2025/05/21/1747794620218-4fbf858f-b94b-4648-983e-a04964b4ebae.png)

ç³»ç»Ÿè‡ªå¸¦çš„ `docker` ä»åœ¨ `/var/run/docker.sock` ä¸Šå·¥ä½œï¼Œäº’ä¸æ‰“æ‰°ã€‚

---

### å°† `dev-docker` æ”¾å…¥å…¨å±€ PATH

å¦‚æœæƒ³å…¨å±€ç”Ÿæ•ˆï¼Œè¿è¡Œä¸‹æ–¹å‘½ä»¤ã€‚ä½†æ³¨æ„ï¼šæ‡’çŒ«å¾®æœé‡å¯å `/usr/local/bin` ä¼šè¢«è¿˜åŸã€‚â€

```bash
sudo install -m 755 ./dev-docker /usr/local/bin/
```

### ä¸€é”®åŒ–è„šæœ¬

```bash
#!/usr/bin/env bash
# init-docker-dev.sh
set -e
mkdir dev
BASE=$(realpath "./dev")
mkdir -p "$BASE"/{data,exec}

cat > "$BASE/daemon.json" <<EOF
{
  "data-root": "$BASE/data",
  "exec-root": "$BASE/exec",
  "pidfile": "$BASE/docker.pid",
  "hosts": ["unix://$BASE/docker.sock"],
  "containerd-namespace": "dev-docker",
  "containerd-plugins-namespace": "dev-docker"
}
EOF

dockerd --config-file="$BASE/daemon.json" --log-level=info &

cat > "./dev-docker" <<EOF
#!/usr/bin/env bash
export DOCKER_HOST=unix://$BASE/docker.sock
exec docker "\$@"
EOF
chmod +x ./dev-docker

echo "ğŸ‰ Dev Docker å·²å°±ç»ªï¼Œä½¿ç”¨ ./dev-docker è®¿é—®ï¼"

```

å¯åŠ¨è„šæœ¬ï¼š

```bash
chmod +x init-docker-dev.sh   # èµ‹å¯æ‰§è¡Œæƒé™ï¼ˆè‹¥è„šæœ¬æ˜¯ä¸‹è½½çš„ï¼‰
./init-docker-dev.sh
```

è¿è¡Œå®Œè„šæœ¬åï¼Œåç»­å°±åœ¨å½“å‰ç›®å½•ç›´æ¥æ•² `./dev-docker <command>` å³å¯ï¼›
å¦‚æœä¹‹å‰å·²å°† `dev-docker` å®‰è£…åˆ° PATHï¼Œå…¨å±€ä¹Ÿå¯ä»¥ç›´æ¥ `dev-docker ps`

è„šæœ¬æ‰§è¡Œè®°å½•å¦‚ä¸‹ï¼š

```
ğŸ‰ Dev Docker å·²å°±ç»ªï¼Œä½¿ç”¨ ./dev-docker è®¿é—®ï¼
ubuntu@ip-172-31-29-78:~$ INFO[2025-05-20T12:55:02.071795870Z] Starting up
INFO[2025-05-20T12:55:02.072949048Z] detected 127.0.0.53 nameserver, assuming systemd-resolved, so using resolv.conf: /run/systemd/resolve/resolv.conf
INFO[2025-05-20T12:55:02.157745008Z] Loading containers: start.
INFO[2025-05-20T12:55:02.331021502Z] Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --bip can be used to set a preferred IP address
INFO[2025-05-20T12:55:02.394567874Z] Loading containers: done.
INFO[2025-05-20T12:55:02.413944743Z] Docker daemon                                 commit="26.1.3-0ubuntu1~24.04.1" containerd-snapshotter=false storage-driver=overlay2 version=26.1.3
INFO[2025-05-20T12:55:02.414179613Z] Daemon has completed initialization
INFO[2025-05-20T12:55:02.471933824Z] API listen on /home/ubuntu/ddd/dev/docker.sock
```

**sudo ./dev-docker info**æŸ¥çœ‹ä¿¡æ¯ï¼š

```
sudo ./dev-docker info

Client:
 Version:    26.1.3
 Context:    default
 Debug Mode: false

Server:
 Containers: 0
  Running: 0
  Paused: 0
  Stopped: 0
 Images: 0
 Server Version: 26.1.3
 Storage Driver: overlay2
  Backing Filesystem: extfs
  Supports d_type: true
  Using metacopy: false
  Native Overlay Diff: true
  userxattr: false
 Logging Driver: json-file
 Cgroup Driver: systemd
 Cgroup Version: 2
 Plugins:
  Volume: local
  Network: bridge host ipvlan macvlan null overlay
  Log: awslogs fluentd gcplogs gelf journald json-file local splunk syslog
 Swarm: inactive
 Runtimes: io.containerd.runc.v2 runc
 Default Runtime: runc
 Init Binary: docker-init
 containerd version:
 runc version:
 init version:
 Security Options:
  apparmor
  seccomp
   Profile: builtin
  cgroupns
 Kernel Version: 6.8.0-1024-aws
 Operating System: Ubuntu 24.04.2 LTS
 OSType: linux
 Architecture: aarch64
 CPUs: 2
 Total Memory: 1.8GiB
 Name: ip-172-31-29-78
 ID: b6f661de-2099-4b23-aff8-1a55e35833d9
 Docker Root Dir: /home/ubuntu/ddd/dev/data
 Debug Mode: false
 Experimental: false
 Insecure Registries:
  127.0.0.0/8
 Live Restore Enabled: false
```

**./dev-docker pull ubuntu** ä¸‹è½½ imagesï¼š

```
ubuntu@ip-172-31-29-78:~$ sudo ./dev-docker pull ubuntu
Using default tag: latest
latest: Pulling from library/ubuntu
2f074dc76c5d: Pull complete
Digest: sha256:6015f66923d7afbc53558d7ccffd325d43b4e249f41a6e93eef074c9505d2233
Status: Downloaded newer image for ubuntu:latest
docker.io/library/ubuntu:latest
```

**æ£€æŸ¥ docker ç‰ˆæœ¬ï¼š**

```bash
ubuntu@ip-172-31-29-78:~$ dev-docker  --version
Docker version 26.1.3, build 26.1.3-0ubuntu1~24.04.1
ubuntu@ip-172-31-29-78:~$ docker --version
Docker version 26.1.3, build 26.1.3-0ubuntu1~24.04.1

```

### ä¸ä½¿ç”¨çš„æ—¶å€™å¦‚ä½•å¸è½½ï¼Ÿ

##### åŠæ³• 1: ps aux | grep dockerd æŸ¥çœ‹ docker è¿›ç¨‹çš„ PID å·ï¼Œç„¶ååˆ é™¤

```bash
ps aux | grep dockerd
root         470  0.8  0.3 2653088 100248 ?      Ssl  07:42   0:11 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
root        2226  6.6  0.6 7246472 227108 ?      Ssl  07:42   1:37 /usr/bin/dockerd --config-file /lzcsys/etc/docker/daemon.json
root       27520  0.0  0.2 2874220 90788 ?       Ssl  07:46   0:00 /usr/bin/dockerd --config-file /lzcsys/var/playground/daemon.json
root      127241  0.5  0.2 2636632 92720 pts/1   Sl   07:52   0:04 dockerd --config-file=/root/dev/daemon.json --log-level=info
root      405552  0.0  0.0   3748  2048 pts/1    S+   08:06   0:00 grep --colour=auto dockerd
---
lzcbox-029c588e ~ # kill -15 127241
lzcbox-029c588e ~ # INFO[2025-05-21T08:10:58.184799932+08:00] Processing signal 'terminated'
INFO[2025-05-21T08:10:58.198235413+08:00] stopping event stream following graceful shutdown  error="<nil>" module=libcontainerd namespace=dev-docker
INFO[2025-05-21T08:10:58.203590577+08:00] Daemon shutdown complete
---
lzcbox-029c588e ~ # ps aux | grep dockerd
root         470  0.7  0.3 2653088 100212 ?      Ssl  07:42   0:13 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
root        2226  7.8  0.7 7246472 233080 ?      Ssl  07:42   2:18 /usr/bin/dockerd --config-file /lzcsys/etc/docker/daemon.json
root       27520  0.0  0.2 2874220 92644 ?       Ssl  07:46   0:00 /usr/bin/dockerd --config-file /lzcsys/var/playground/daemon.json
root      568622  0.0  0.0   3748  2048 pts/1    S+   08:11   0:00 grep --colour=auto dockerd
```

##### åŠæ³• 2: pkill -f './dev/daemon.json' æŒ‡å®šæ–‡ä»¶åˆ é™¤ï¼š

```bash
pkill -f './dev/daemon.json'
INFO[2025-05-21T08:14:06.721816466+08:00] Processing signal 'terminated'
lzcbox-029c588e ~ # INFO[2025-05-21T08:14:06.728822927+08:00] stopping event stream following graceful shutdown  error="<nil>" module=libcontainerd namespace=dev-docker
INFO[2025-05-21T08:14:06.734923834+08:00] Daemon shutdown complete

[1]+  Done                    dockerd --config-file="./dev/daemon.json" --log-level=info
lzcbox-029c588e ~ # ps aux | grep dockerd
root         470  0.7  0.3 2653088 100340 ?      Ssl  07:42   0:14 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
root        2226  8.3  0.7 7246472 234356 ?      Ssl  07:42   2:41 /usr/bin/dockerd --config-file /lzcsys/etc/docker/daemon.json
root       27520  0.0  0.2 2874220 92500 ?       Ssl  07:46   0:01 /usr/bin/dockerd --config-file /lzcsys/var/playground/daemon.json
root      663902  0.0  0.0   3748  1792 pts/1    S+   08:14   0:00 grep --colour=auto dockerd
```

**æ¸…é™¤æ•°æ®**

```
rm -rf ./dev                   # åˆ æ•°æ®ç›®å½•
sudo rm -f /usr/local/bin/dev-docker   # è‹¥è£…è¿‡ PATH
```

### æœ€å

å†å¤šä¸€å¥— Dockerï¼Œä¸æ˜¯ä¸ºäº†ç‚«æŠ€ï¼Œè€Œæ˜¯ç»™å¼€å‘æˆ–è€…æµ‹è¯•ç¯å¢ƒä¸€ä¸ªâ€œéšæ—¶å¯é‡ç½®ã€å¤©ç„¶éš”ç¦»ã€ä½æˆæœ¬å›æ”¶â€çš„ä¿é™©ç®±ã€‚å­¦ä¼šè¿™ä¸€æ‹›ï¼Œä½ å°±èƒ½åœ¨æ‡’çŒ«å¾®æœä¹ƒè‡³ä»»ä½• Linux æœåŠ¡å™¨ä¸Šï¼Œæ”¾å¿ƒå¤§èƒ†åœ°å°é²œæ–°å†…æ ¸ã€æ–° runtimeï¼Œç”šè‡³å¤åˆ»ç”Ÿäº§ bug â€”â€” ç„¶åä¸€å¥ `pkill` + `rm -rf dev/`ï¼Œä¸–ç•Œç¬é—´æ¸…çˆ½å¦‚åˆã€‚ç¥ç©å¾—å°½å…´ï¼
