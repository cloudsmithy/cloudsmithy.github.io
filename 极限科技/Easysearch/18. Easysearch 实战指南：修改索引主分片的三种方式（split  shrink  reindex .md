---
title: Easysearch å®æˆ˜æŒ‡å—ï¼šä¿®æ”¹ç´¢å¼•ä¸»åˆ†ç‰‡çš„ä¸‰ç§æ–¹å¼ï¼ˆsplit  shrink  reindex
tags: æœç´¢å¼•æ“ï¼ˆESï¼‰
toc: true
categories: æé™ç§‘æŠ€
date: 2025-06-28 00:00:00
---

åœ¨ Easysearchï¼ˆå…¼å®¹ Elasticsearchï¼‰çš„æ¶æ„ä¸­ï¼Œç´¢å¼•çš„ä¸»åˆ†ç‰‡æ•°ï¼ˆ`index.number_of_shards`ï¼‰ä¸€æ—¦åˆ›å»ºå°±æ— æ³•ç›´æ¥ä¿®æ”¹ã€‚è¿™ç»™å®é™…ä½¿ç”¨å¸¦æ¥æŒ‘æˆ˜ï¼š

- è®¾å¾—å¤ªå°‘ï¼ŒæŸ¥è¯¢/å†™å…¥ç“¶é¢ˆå‡ºç°ï¼›
- è®¾å¾—å¤ªå¤šï¼Œèµ„æºæµªè´¹ã€é›†ç¾¤ä¸ç¨³ï¼›
- æƒ³å˜æ›´ç»“æ„ï¼Œå´å‘ç°é…ç½®æ˜¯â€œå†™æ­»â€çš„ã€‚

æœ¬æ–‡å°†å¸¦ä½ æ·±å…¥äº†è§£ä¸‰ç§å¸¸è§ä½†æœ¬è´¨ä¸åŒçš„ç´¢å¼•é‡æ„æ–¹å¼ï¼š`split`ã€`shrink`ã€`reindex`ï¼Œæ•™ä½ å¦‚ä½•é€‰æ‹©åˆé€‚æ–¹æ¡ˆã€å®‰å…¨æ“ä½œï¼Œå¹¶è§£é‡Šä¸ºä»€ä¹ˆ**split + shrink æ— æ³•å–ä»£ reindex**ã€‚

---

## ğŸ“Œ ä¸€å¼ å›¾æ¦‚è§ˆä¸‰ç§æ–¹å¼

| æ–¹æ³•      | æ˜¯å¦é‡å»ºç´¢å¼• | å¯å¦åŸåä½¿ç”¨    | æ”¹åˆ†ç‰‡æ•°é™åˆ¶            | æ˜¯å¦ä¿ç•™æ•°æ® | æ˜¯å¦æ”¹ç»“æ„ï¼ˆmapping/settingsï¼‰ | å¸¸è§ç”¨é€”             |
| --------- | ------------ | --------------- | ----------------------- | ------------ | ------------------------------ | -------------------- |
| `split`   | âœ… æ–°å»ºç´¢å¼•  | âŒ ä¸æ”¯æŒ       | åªèƒ½ Ã— å€æ•°ï¼ˆå¦‚ 1â†’2â†’4ï¼‰ | âœ… æ˜¯        | âŒ å¦                          | æå‡å†™å…¥å¹¶å‘/è¯»æ€§èƒ½  |
| `shrink`  | âœ… æ–°å»ºç´¢å¼•  | âŒ ä¸æ”¯æŒ       | åªèƒ½ Ã· å› æ•°ï¼ˆå¦‚ 4â†’2â†’1ï¼‰ | âœ… æ˜¯        | âŒ å¦                          | åˆå¹¶å†å²æ•°æ®åˆ†ç‰‡     |
| `reindex` | âœ… æ–°å»ºç´¢å¼•  | âœ… æ”¯æŒï¼ˆå…ˆåˆ ï¼‰ | ä»»æ„                    | âœ… æ˜¯        | âœ… æ”¯æŒ                        | è‡ªå®šä¹‰ç»“æ„/åˆ†ç‰‡/å‡çº§ |

---

## ğŸ”§ ä¸€ã€splitï¼šå°†åˆ†ç‰‡æ•°é‡å€å¢ï¼ˆå¦‚ 1 â†’ 2 â†’ 4ï¼‰

> **é€‚ç”¨äºï¼š** æå‡å¹¶å‘èƒ½åŠ›ã€å¢åŠ æŸ¥è¯¢/å†™å…¥å¹¶è¡Œåº¦ã€‚

<!-- more -->

### âœ… æ¡ä»¶è¦æ±‚ï¼š

- åŸå§‹ç´¢å¼•å¿…é¡»è®¾ç½® `index.blocks.write: true`ï¼ˆåªè¯»ï¼‰ï¼›ä¸»è¦æ˜¯é˜²æ­¢å†™å…¥ç»§ç»­å¢é•¿ã€‚
- æ–°åˆ†ç‰‡æ•°å¿…é¡»æ˜¯åŸä¸»åˆ†ç‰‡çš„ **å€æ•°**ï¼›
- ä¸èƒ½ä½¿ç”¨åŸåï¼Œç›®æ ‡ç´¢å¼•å¿…é¡»å¦èµ·æ–°åã€‚

### ğŸ›  æ“ä½œç¤ºä¾‹ï¼š

````bash
# è®¾ç½®åªè¯»
PUT /abc/_settings
{
  "settings": {
    "index.blocks.write": true
  }
}

å¦‚æœä¸è®¾ç½®ä¸ºåªè¯»çš„è¯ï¼Œå°±æŠ¥é”™ï¼š
```json
{
  "error": {
    "root_cause": [
      {
        "type": "illegal_state_exception",
        "reason": "index abc must be read-only to resize index. use \"index.blocks.write=true\""
      }
    ],
    "type": "illegal_state_exception",
    "reason": "index abc must be read-only to resize index. use \"index.blocks.write=true\""
  },
  "status": 500
}
````

#### æ‹†åˆ†ç´¢å¼•ï¼ˆ1 â†’ 4ï¼‰

```
POST /abc/_split/abc_split_2shards
{
  "settings": {
    "index.number_of_shards": 2
  }
}
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```
{
  "acknowledged": true,
  "shards_acknowledged": true,
  "index": "abc_split_2shards"
}
```

å¦‚æœä¸æ˜¯å€æ•°ä¹Ÿä¼šæŠ¥é”™ï¼š

```json
{
  "error": {
    "root_cause": [
      {
        "type": "illegal_argument_exception",
        "reason": "the number of source shards [13] must be a factor of [25]"
      }
    ],
    "type": "illegal_argument_exception",
    "reason": "the number of source shards [13] must be a factor of [25]"
  },
  "status": 400
}
```

æŸ¥çœ‹ç´¢å¼•çš„ä¿¡æ¯ï¼š

```
GET /abc_split_2shards/_settings?flat_settings=true
```

> /\_settingsï¼šElasticsearch æä¾›çš„ API ç«¯ç‚¹ï¼Œç”¨äºæŸ¥çœ‹ç´¢å¼•è®¾ç½®ã€‚
> ?flat_settings=trueï¼šæŸ¥è¯¢å‚æ•°ï¼Œä½¿è¿”å›ç»“æœä»¥æ‰å¹³åŒ–çš„é”®å€¼å¯¹å½¢å¼å±•ç¤ºï¼ˆè€ŒéåµŒå¥—ç»“æ„ï¼‰ã€‚

å¯ä»¥çœ‹åˆ°ç›®æ ‡çš„ç´¢å¼•ä¹Ÿæ˜¯åªè¯»çš„ï¼Œè¿™åœ¨ Easysearch é‡Œæ˜¯ ElasticSearch ä¸ä¸€æ ·çš„åœ°æ–¹ã€‚

```json
{
  "abc_split_2shards": {
    "settings": {
      "index.blocks.write": "true",
      "index.creation_date": "1750747232004",
      "index.number_of_replicas": "1",
      "index.number_of_shards": "2",
      "index.provided_name": "abc_split_2shards",
      "index.resize.source.name": "abc",
      "index.resize.source.uuid": "3NY_W5B_TzimoEGdoA74cg",
      "index.routing.allocation.initial_recovery._id": null,
      "index.routing_partition_size": "1",
      "index.uuid": "e2BQiTRKTlaTS5OE8kmiXw",
      "index.version.created": "1130099",
      "index.version.upgraded": "1130099"
    }
  }
}
```

ç„¶åä½¿ç”¨è¿™ä¸ªæ¥è§£é” write blockã€‚

```
PUT /abc_split_2shards/_settings
{
  "settings": {
    "index.blocks.write": false
  }
}
```

å¦‚æœä½ ä¸æƒ³è®©ç›®æ ‡ç´¢å¼•å˜æˆåªè¯»ã€‚ä¹Ÿå¯ä»¥åœ¨\_split çš„æ—¶å€™åŠ ä¸Š "index.blocks.write": falseã€‚

```json
POST /abc_split_2sharxds/_split/qwe
{
  "settings": {
    "index.blocks.write": false,
    "index.number_of_shards": 26
  }
}

```

## ğŸ”§ äºŒã€shrinkï¼šå°†åˆ†ç‰‡æ•°é‡æ•´é™¤å‹ç¼©ï¼ˆå¦‚ 8 â†’ 4 â†’ 1ï¼‰

> **é€‚ç”¨äºï¼š** å†å²å½’æ¡£æ•°æ®å‹ç¼©ã€èŠ‚çœå†…å­˜ã€æå‡æŸ¥è¯¢æ•ˆç‡ã€‚

### âœ… æ¡ä»¶è¦æ±‚ï¼š

- æ‰€æœ‰ä¸»åˆ†ç‰‡å¿…é¡»é›†ä¸­åœ¨åŒä¸€èŠ‚ç‚¹ï¼›
- åŸç´¢å¼•å¿…é¡»åªè¯»ï¼›
- æ–°åˆ†ç‰‡æ•°å¿…é¡»æ˜¯æ—§åˆ†ç‰‡æ•°çš„ **å› æ•°**ï¼›
- åŒæ ·ä¸èƒ½ä¿ç•™åŸåï¼Œéœ€æ–°å»ºç´¢å¼•åã€‚

### ğŸ›  æ“ä½œç¤ºä¾‹ï¼š

````bash
# å¼ºåˆ¶æ‰€æœ‰ä¸»åˆ†ç‰‡è°ƒåº¦åˆ° node-1
PUT /source_index/_settings
{
  "settings": {
    "index.blocks.write": true,
    "index.routing.allocation.require._name": "node-1",
    "index.number_of_replicas": 0
  }
}


å¦‚æœä¸æ˜¯åªè¯»åŒæ ·æŠ¥é”™ï¼š
```json
{
  "error": {
    "root_cause": [
      {
        "type": "illegal_state_exception",
        "reason": "index test1 must be read-only to resize index. use \"index.blocks.write=true\""
      }
    ],
    "type": "illegal_state_exception",
    "reason": "index test1 must be read-only to resize index. use \"index.blocks.write=true\""
  },
  "status": 500
}
````

### åˆå¹¶ä¸ºä¸€ä¸ªåˆ†ç‰‡

```
POST /source_index/_shrink/source_index_1
{
  "settings": {
      "index.blocks.write": false,
    "index.number_of_shards": 1
  }
}
```

### è§£é”

```
PUT /source_index_1/_settings
{
  "settings": {
    "index.blocks.write": false
  }
}
```

## ğŸ”§ ä¸‰ã€reindexï¼šæ‹·è´æ•°æ® + æ–°å»ºç»“æ„ + æ›¿æ¢æ—§ç´¢å¼•

> **é€‚ç”¨äºï¼š** ä»»æ„ä¿®æ”¹åˆ†ç‰‡æ•°ã€å­—æ®µç»“æ„ã€settingsï¼Œæˆ–å®ç°â€œçœ‹èµ·æ¥æ”¹äº†åŸç´¢å¼•â€çš„æ•ˆæœã€‚

### âœ… ä¼˜åŠ¿ï¼š

- å”¯ä¸€æ”¯æŒ**ä»»æ„åˆ†ç‰‡æ•°ä¿®æ”¹**ï¼›
- å¯è‡ªç”±é‡æ„ mappingã€settingsï¼›
- å¯æ”¯æŒ**ä¿ç•™åŸå**ï¼ˆåˆ é™¤æ—§ç´¢å¼• + é‡æ–°åˆ›å»ºï¼‰ï¼›
- å¯å¸¦æ¡ä»¶ã€åˆ†é¡µã€è„šæœ¬æ‹·è´æ•°æ®ï¼›
- æ˜¯å”¯ä¸€å¯æ¨¡æ‹Ÿâ€œä¿®æ”¹åŸç´¢å¼•åˆ†ç‰‡â€çš„æ–¹å¼ã€‚

### ğŸ›  æ“ä½œæ­¥éª¤ï¼ˆä¿ç•™åŸåä½†æ”¹å˜ç»“æ„ï¼‰ï¼š

```bash
# 1. åˆ›å»ºä¸´æ—¶ç´¢å¼•ç»“æ„ï¼ˆä½ æƒ³è¦çš„æ–°ç»“æ„ï¼‰
PUT /my_index_v2
{
  "settings": {
    "index.number_of_shards": 5,
    "index.number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "user": { "type": "keyword" },
      "message": { "type": "text" }
    }
  }
}

# 2. æ‹·è´æ•°æ®
POST /_reindex
{
  "source": { "index": "my_index" },
  "dest":   { "index": "my_index_v2" }
}

# 3. åˆ é™¤æ—§ç´¢å¼•ï¼ˆè°¨æ…ï¼‰
DELETE /my_index

# 4. åˆ›å»ºåŒåç´¢å¼•ï¼ˆæ–°ç»“æ„ï¼‰
PUT /my_index
{
  "settings": {
    "index.number_of_shards": 3,
    "index.number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "user": { "type": "keyword" },
      "message": { "type": "text" }
    }
  }
}

# 5. å†æ¬¡æ‹·è´æ•°æ®ï¼ˆå›å¡«ï¼‰
POST /_reindex
{
  "source": { "index": "my_index_v2" },
  "dest":   { "index": "my_index" }
}

6.  æŸ¥çœ‹ç´¢å¼•ï¼Œå¹¶ä¸”åˆ é™¤ç›®æ ‡ç´¢å¼•
GET _cat/indices/my_index*?v

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/64f99ab7b3ba4b4a8e18d53d4e32fab5.png)
æœ€ååˆ é™¤my_index_v2 å³å¯

DELETE /my_index_v2
```

---

## âš ï¸ ä¸ºä»€ä¹ˆ shrink + split ä¸èƒ½æ›¿ä»£ reindexï¼Ÿ

å¾ˆå¤šç”¨æˆ·ä¼šé—®ï¼šèƒ½ä¸èƒ½ `shrink â†’ split` æˆ– `split â†’ shrink` æ‹¼æ¥å‡ºä»»æ„åˆ†ç‰‡æ•°ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š**æ•°å­¦ä¸Šä¸æˆç«‹ + å®æˆ˜é™åˆ¶å¤ªå¤šã€‚**

| æ“ä½œ            | è¯´æ˜                                                                  |
| --------------- | --------------------------------------------------------------------- |
| split åªèƒ½å€å¢  | ä¾‹å¦‚ï¼š1 â†’ 2 â†’ 4 â†’ 8 âœ…ï¼Œä½†ä¸èƒ½å˜æˆ 3ã€5ã€6 âŒ                         |
| shrink åªèƒ½æ•´é™¤ | ä¾‹å¦‚ï¼š8 â†’ 4 â†’ 2 â†’ 1 âœ…ï¼Œä½†ä¸èƒ½å˜æˆ 3ã€5 âŒ                            |
| äºŒè€…ç»„åˆ        | å—é™äºå€æ•° Ã— å› æ•°å…³ç³»ï¼Œ**ä¸æ˜¯ä¸‡èƒ½å˜æ¢**ï¼ˆå¤§å¤šæ•°ç›®æ ‡åˆ†ç‰‡æ•°æ ¹æœ¬åˆ°ä¸äº†ï¼‰ |

### âœ… å”¯ä¸€ä¸‡èƒ½æ–¹å¼ï¼š`reindex`

å¯ä»¥ä»»æ„ï¼š

- è°ƒæ•´åˆ†ç‰‡æ•° âœ…
- ä¿®æ”¹å­—æ®µç»“æ„ âœ…
- æ”¹ settings âœ…
- ä¿ç•™ç´¢å¼•å âœ…

---

## âœ… æœ€ä½³å®è·µæ€»ç»“

| åœºæ™¯                         | æ¨èæ–¹å¼                        | ç†ç”±                     |
| ---------------------------- | ------------------------------- | ------------------------ |
| å†™å…¥å¹¶å‘ä¸è¶³ï¼ˆ1 â†’ 4ï¼‰        | split                           | å¿«é€Ÿã€ä½é£é™©             |
| å­˜å‚¨/æŸ¥è¯¢ä¼˜åŒ–ï¼ˆ8 â†’ 1ï¼‰       | shrink                          | èŠ‚çœèµ„æºã€é€‚åˆå½’æ¡£       |
| ä¿®æ”¹ç´¢å¼•ç»“æ„ã€å­—æ®µã€settings | reindex                         | æœ€çµæ´»ã€å”¯ä¸€æ”¯æŒä»»æ„ç»“æ„ |
| æƒ³ä¿ç•™åŸåä½†æ”¹åˆ†ç‰‡æ•°         | reindexï¼ˆé…åˆ delete/recreateï¼‰ | åªæœ‰å®ƒèƒ½å®ç°             |
| ä¸æƒ³ä¸­æ–­æœåŠ¡                 | reindex + alias åˆ‡æ¢            | alias å®ç°æ— ç¼æ›¿æ¢       |

---

## ğŸš€ é™„åŠ å»ºè®®

S\* split/shrink ä¸€èˆ¬ç”¨äº **çº¿ä¸Šå°èŒƒå›´ç»“æ„è°ƒæ•´**ï¼›

- reindex ç”¨äº **å‡çº§ã€æ¸…æ´—ã€ç»“æ„ä¼˜åŒ–**ç­‰æ›´å¤§ç²’åº¦çš„æ”¹é€ ï¼›
- å¦‚æœä½ ä¸æƒ³ä¸­æ–­æœåŠ¡ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ **alias + reindex** åšå¹³æ»‘åˆ‡æ¢ï¼›
- ä¸å»ºè®®ç”¨ shrink + split æ‹¼æ¥æ–¹æ¡ˆï¼Œå®é™…è¿ç»´æ€§å·®ã€æ•°å­¦å…³ç³»è‹›åˆ»ã€‚E
